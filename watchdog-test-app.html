<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Watchdog Test App</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
      color: #333;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .controls {
      margin-top: 20px;
      display: flex;
      gap: 10px;
    }
    button {
      padding: 10px 15px;
      background-color: #4285f4;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background-color: #3367d6;
    }
    button.danger {
      background-color: #ea4335;
    }
    button.danger:hover {
      background-color: #d33426;
    }
    .status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 4px;
    }
    .active {
      background-color: #e6f4ea;
      color: #137333;
    }
    .inactive {
      background-color: #fce8e6;
      color: #c5221f;
    }
    .log {
      margin-top: 20px;
      padding: 10px;
      background-color: #f8f9fa;
      border-radius: 4px;
      height: 200px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Watchdog Test App</h1>
    <p>This app sends heartbeats to the parent window to test the watchdog functionality.</p>
    
    <div class="status active" id="status">
      Heartbeat Status: ACTIVE
    </div>
    
    <div class="controls">
      <button id="stopHeartbeats" class="danger">Stop Heartbeats</button>
      <button id="resumeHeartbeats">Resume Heartbeats</button>
      <button id="simulateFreeze">Simulate Freeze (5s)</button>
    </div>
    
    <div class="log" id="log"></div>
  </div>

  <script>
    // DOM Elements
    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');
    const stopBtn = document.getElementById('stopHeartbeats');
    const resumeBtn = document.getElementById('resumeHeartbeats');
    const freezeBtn = document.getElementById('simulateFreeze');
    
    // Heartbeat variables
    let heartbeatInterval = null;
    let heartbeatActive = true;
    
    // Logging function
    function log(message) {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.textContent = `[${timestamp}] ${message}`;
      logEl.appendChild(logEntry);
      logEl.scrollTop = logEl.scrollHeight;
      console.log(`[Watchdog Test] ${message}`);
    }
    
    // Update status display
    function updateStatus(active) {
      heartbeatActive = active;
      if (active) {
        statusEl.textContent = 'Heartbeat Status: ACTIVE';
        statusEl.className = 'status active';
      } else {
        statusEl.textContent = 'Heartbeat Status: INACTIVE';
        statusEl.className = 'status inactive';
      }
    }
    
    // Send heartbeat to parent window
    function sendHeartbeat() {
      try {
        if (window.parent && window.parent !== window && heartbeatActive) {
          window.parent.postMessage('heartbeat', '*');
          log('Heartbeat sent to parent window');
        }
      } catch (e) {
        log(`Error sending heartbeat: ${e.message}`);
      }
    }
    
    // Start sending heartbeats
    function startHeartbeats() {
      if (heartbeatInterval) {
        clearInterval(heartbeatInterval);
      }
      heartbeatInterval = setInterval(sendHeartbeat, 1000);
      updateStatus(true);
      log('Started sending heartbeats every 1 second');
    }
    
    // Stop sending heartbeats
    function stopHeartbeats() {
      if (heartbeatInterval) {
        clearInterval(heartbeatInterval);
        heartbeatInterval = null;
      }
      updateStatus(false);
      log('Stopped sending heartbeats - watchdog should trigger in about 5 seconds');
    }
    
    // Simulate application freeze
    function simulateFreeze() {
      log('Simulating application freeze for 5 seconds...');
      stopHeartbeats();
      
      // Use a blocking operation to simulate freeze
      const startTime = Date.now();
      while (Date.now() - startTime < 5000) {
        // Blocking operation
        if ((Date.now() - startTime) % 1000 < 10) {
          log(`Freeze: ${Math.floor((Date.now() - startTime) / 1000)}s elapsed`);
        }
      }
      
      log('Freeze simulation complete');
      startHeartbeats();
    }
    
    // Event listeners
    stopBtn.addEventListener('click', stopHeartbeats);
    resumeBtn.addEventListener('click', startHeartbeats);
    freezeBtn.addEventListener('click', simulateFreeze);
    
    // Listen for messages from parent
    window.addEventListener('message', (event) => {
      if (event.data === 'stop-heartbeats') {
        stopHeartbeats();
        log('Received stop command from parent');
      } else if (event.data === 'resume-heartbeats') {
        startHeartbeats();
        log('Received resume command from parent');
      }
    });
    
    // Initialize on page load
    window.addEventListener('load', () => {
      log('Page loaded, starting heartbeat system');
      startHeartbeats();
      sendHeartbeat(); // Send initial heartbeat
    });
  </script>
</body>
</html>
